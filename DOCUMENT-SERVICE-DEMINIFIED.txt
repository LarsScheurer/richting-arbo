import { db } from '../firebase';
import { collection, getDocs, addDoc, doc, updateDoc, query, where, orderBy, arrayUnion, arrayRemove } from 'firebase/firestore';

export const documentService = {
    // Haal alle documenten op (voor het dashboard)
    getDocuments: async () => {
        try {
            [cite_start]// [cite: 1507]
            const q = query(collection(db, "documents"), orderBy("uploadedAt", "desc"));
            const snapshot = await getDocs(q);
            return snapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    viewedBy: data.viewedBy || [],
                    likedBy: data.likedBy || [],
                    tags: data.tags || []
                };
            });
        } catch (error) {
            console.error("Error getting documents:", error);
            return [];
        }
    },

    // Haal documenten op voor een specifiek klant dossier
    getDocumentsForCustomer: async (customerId) => {
        try {
            [cite_start]// [cite: 1508]
            const q = query(collection(db, "documents"), where("customerId", "==", customerId));
            const snapshot = await getDocs(q);
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                .sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
        } catch (error) {
            console.error("Error getting customer docs", error);
            return [];
        }
    },

    // Nieuw document toevoegen
    addDocument: async (docData) => {
        [cite_start]// [cite: 1509]
        // We gebruiken addDoc zodat Firestore zelf een ID genereert, 
        // of setDoc als je de ID uit de frontend (doc_timestamp) wilt behouden.
        // In je originele code werd setDoc gebruikt.
        await utilSetDoc(docData); 
    },

    // Update views, likes of archiveer status
    updateDocumentStats: async (docId, userId, action) => {
        [cite_start]// [cite: 1509-1510]
        const docRef = doc(db, "documents", docId);
        
        if (action === "view") {
            await updateDoc(docRef, { viewedBy: arrayUnion(userId) });
        } else if (action === "like") {
            // Let op: In een echte app moet je eerst checken of hij al geliked is om te togglen.
            // Hier gaan we er even vanuit dat de UI die logica afhandelt en de juiste actie stuurt,
            // of we gebruiken een transactie. Voor nu simpel:
            // In originele code: check local state -> update arrayUnion/Remove
             await updateDoc(docRef, { likedBy: arrayUnion(userId) }); 
             // (Voor remove zou je arrayRemove gebruiken)
        } else if (action === "archive") {
             // Dit vereist eerst de huidige status ophalen, of de nieuwe status meegeven als argument
             // In originele code werd de status eerst opgehaald.
        }
    }
};

// Helper voor de addDocument (omdat origineel 'ui' en 'So' gebruikte)
import { setDoc } from 'firebase/firestore';
const utilSetDoc = async (data) => {
    await setDoc(doc(db, "documents", data.id), data);
}



